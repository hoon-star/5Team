<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}{{ book.title }} - 책 상세{% endblock %}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}?v=1.0.3">
</head>
<body>
    <div class="book-detail-card">
        <div class="book-info">
            {% if book.image %}
            <img src="{{ book.image }}" alt="{{ book.title }} 표지" class="book-cover">
            {% else %}
            <div class="no-image-detail">No Image</div>
            {% endif %}
            <div class="book-text-info">
                <h1>{{ book.title }}</h1>
                <p class="detail-author"><strong>저자:</strong> {{ book.author }}</p>
                <p class="detail-publisher"><strong>출판사:</strong> {{ book.publisher }}</p>
                <p class="detail-pubdate"><strong>출판일:</strong> {{ book.pubdate }}</p>
                <p class="detail-isbn"><strong>ISBN:</strong> {{ book.isbn }}</p>
                <div class="description-box">
                    <h2>책 줄거리</h2>
                    <p>{{ book.description|safe }}</p> {# HTML 태그가 포함될 수 있으므로 safe 필터 사용 #}
                </div>
            </div>
        </div>

        <hr>

        <div class="reviews-section">
            <h2>독자 리뷰</h2>
            {% if logged_in %} {# Flask-Login 대신 logged_in 변수 사용 #}
            <div class="review-form-container">
                <h3>리뷰 작성하기</h3>
                <form action="{{ url_for('add_review', book_id=book.id) }}" method="POST" class="review-form">
                    <textarea name="content" placeholder="이 책에 대한 생각을 자유롭게 적어주세요..." rows="5" required></textarea>
                    <div class="rating-input">
                        <label for="rating">평점 (1-5):</label>
                        <input type="number" id="rating" name="rating" min="1" max="5" placeholder="예: 5" class="rating-field">
                    </div>
                    <button type="submit">리뷰 등록</button>
                </form>
            </div>
            {% else %}
            <p class="login-prompt">리뷰를 작성하려면 <a href="{{ url_for('login') }}">로그인</a>해주세요.</p>
            {% endif %}

            <div class="review-list">
                {% if reviews %}
                    {% for review in reviews %}
                    <div class="review-item">
                        <p class="review-meta"><strong>{{ review.username }}</strong> 
                            {% if review.rating %}
                                - 평점: {{ review.rating }}점
                            {% endif %}
                            {# created_at 컬럼 제거 #}
                        </p>
                        <p class="review-content">{{ review.content }}</p>
                    </div>
                    {% endfor %}
                {% else %}
                <p>아직 등록된 리뷰가 없습니다. 첫 번째 리뷰를 남겨주세요!</p>
                {% endif %}
            </div>
        </div>
    </div>
</body>
</html>